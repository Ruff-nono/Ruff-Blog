<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>gin框架(二)、服务启动源码解析 | Ruff&#39;s Blog</title>
<meta name="keywords" content="go, gin">
<meta name="description" content="1、服务启动过程 func main() { r := gin.Default() r.GET(&#34;/ping&#34;, func(c *gin.Context) { c.JSON(http.StatusOK, gin.H{ &#34;message&#34;: &#34;pong&#34;, }) }) r.Run() } 1. gin.Default() gin.Default() 函数会生成一个默认的 Engine 对象，里面包含了 2 个默认的常用插件，分别是 Logger 和 Recover">
<meta name="author" content="
作者:&nbsp;路非非">
<link rel="canonical" href="http://localhost:1313/posts/tech/gin/2-start-analyze/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.ee5b3dea7b41dd29319b62e45e966318b6b809531e2cf0f740600b0f7326d25b.css" integrity="sha256-7ls96ntB3Skxm2LkXpZjGLa4CVMeLPD3QGALD3Mm0ls=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="gin框架(二)、服务启动源码解析" />
<meta property="og:description" content="1、服务启动过程 func main() { r := gin.Default() r.GET(&#34;/ping&#34;, func(c *gin.Context) { c.JSON(http.StatusOK, gin.H{ &#34;message&#34;: &#34;pong&#34;, }) }) r.Run() } 1. gin.Default() gin.Default() 函数会生成一个默认的 Engine 对象，里面包含了 2 个默认的常用插件，分别是 Logger 和 Recover" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/tech/gin/2-start-analyze/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-03T15:50:33+08:00" />
<meta property="article:modified_time" content="2022-11-03T15:50:33+08:00" />
<meta property="og:see_also" content="http://localhost:1313/posts/tech/gin/1-start/" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="gin框架(二)、服务启动源码解析"/>
<meta name="twitter:description" content="1、服务启动过程 func main() { r := gin.Default() r.GET(&#34;/ping&#34;, func(c *gin.Context) { c.JSON(http.StatusOK, gin.H{ &#34;message&#34;: &#34;pong&#34;, }) }) r.Run() } 1. gin.Default() gin.Default() 函数会生成一个默认的 Engine 对象，里面包含了 2 个默认的常用插件，分别是 Logger 和 Recover"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📜笔记",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "👨🏻‍💻 技术",
      "item": "http://localhost:1313/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "gin框架",
      "item": "http://localhost:1313/posts/tech/gin/"
    }, 
    {
      "@type": "ListItem",
      "position":  5 ,
      "name": "gin框架(二)、服务启动源码解析",
      "item": "http://localhost:1313/posts/tech/gin/2-start-analyze/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "gin框架(二)、服务启动源码解析",
  "name": "gin框架(二)、服务启动源码解析",
  "description": "1、服务启动过程 func main() { r := gin.Default() r.GET(\u0026#34;/ping\u0026#34;, func(c *gin.Context) { c.JSON(http.StatusOK, gin.H{ \u0026#34;message\u0026#34;: \u0026#34;pong\u0026#34;, }) }) r.Run() } 1. gin.Default() gin.Default() 函数会生成一个默认的 Engine 对象，里面包含了 2 个默认的常用插件，分别是 Logger 和 Recover",
  "keywords": [
    "go", "gin"
  ],
  "articleBody": "1、服务启动过程 func main() { r := gin.Default() r.GET(\"/ping\", func(c *gin.Context) { c.JSON(http.StatusOK, gin.H{ \"message\": \"pong\", }) }) r.Run() } 1. gin.Default() gin.Default() 函数会生成一个默认的 Engine 对象，里面包含了 2 个默认的常用插件，分别是 Logger 和 Recovery，Logger 用于输出请求日志， Recovery 确保单个请求发生 panic 时记录异常堆栈日志，输出统一的错误响应。\n// Default returns an Engine instance with the Logger and Recovery middleware already attached. func Default() *Engine { // 输出debug日志 debugPrintWARNINGDefault() // 创建一个默认无路由无中间件的引擎 engine := New() // 默认注册全局日志和异常捕获中间件 engine.Use(Logger(), Recovery()) return engine } Gin框架中注册中间件是通过 engine.Use(xx)的方式。\nginMode分为三种场景下的模式，默认为debug模式，可以通过环境变量或代码声明的方式修改模式\ndebugCode = iota releaseCode testCode [GIN-debug] [WARNING] Running in \"debug\" mode. Switch to \"release\" mode in production. - using env: export GIN_MODE=release - using code: gin.SetMode(gin.ReleaseMode) 2. engine.GET() router.Handle(httpMethod, relativePath, handlers) 用来创建路由，同时框架提供了 GET, POST 等简单方法，relativePath 和 handlers 分别与 router 中 basePath 、handlers 共同组成最终的 absolutePath 和 handlers。\n// Unless otherwise noted, these are defined in RFC 7231 section 4.3. const ( MethodGet = \"GET\" MethodHead = \"HEAD\" MethodPost = \"POST\" MethodPut = \"PUT\" MethodPatch = \"PATCH\" // RFC 5789 MethodDelete = \"DELETE\" MethodConnect = \"CONNECT\" MethodOptions = \"OPTIONS\" MethodTrace = \"TRACE\" ) // GET is a shortcut for router.Handle(\"GET\", path, handle). // 注册一个匹配路径为 relativePath 的GET请求路由 func (group *RouterGroup) GET(relativePath string, handlers ...HandlerFunc) IRoutes { return group.handle(http.MethodGet, relativePath, handlers) } // ----- func (group *RouterGroup) handle(httpMethod, relativePath string, handlers HandlersChain) IRoutes { //以'/'连接group.basePath 与 relativePath absolutePath := group.calculateAbsolutePath(relativePath) // 合并 group.Handlers 与 handlers handlers = group.combineHandlers(handlers) // 将请求路由添加到engine中 group.engine.addRoute(httpMethod, absolutePath, h andlers) return group.returnObj() } 3. engine.Run() // Run attaches the router to a http.Server and starts listening and serving HTTP requests. // It is a shortcut for http.ListenAndServe(addr, router) // Note: this method will block the calling goroutine indefinitely unless an error happens. func (engine *Engine) Run(addr ...string) (err error) { // 打印error日志 defer func() { debugPrintError(err) }() // 我们可以通过 router.SetTrustedProxies([]string{\"192.168.1.2\"}) 设置受信任的代理 if engine.isUnsafeTrustedProxies() { debugPrint(\"[WARNING] You trusted all proxies, this is NOT safe. We recommend you to set a value.\\n\" + \"Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies for details.\") } // 解析端口地址，默认使用环境变量PORT，或:8080 address := resolveAddress(addr) debugPrint(\"Listening and serving HTTP on %s\\n\", address) // 监听端口地址，engine.Handler作为请求处理函数 err = http.ListenAndServe(address, engine.Handler()) return } 4.总结 Engine 是 Gin 框架的核心数据结构，通过 Engine 对象定义服务路由信息后，使用 http server 启动服务并监听端口地址。\nEngine 的本质只是对内置的 HTTP 服务器的包装，让它使用起来更加便捷。HTTP 服务器使用的是 Go 语言内置的 http server，\n2、结构体 classDiagram Engine --|\u003e RouterGroup RouterGroup --o Engine RouterGroup --|\u003e IRouter IRouter --|\u003e IRoutes Engine --o methodTree methodTree --o node class Engine{ +[]methodTree methodTrees +addRoute() +Run() +ServeHTTP() } class RouterGroup{ +Handlers HandlersChain -engine *Engine +Use() +Group() } class IRouter{ \u003c\u003einterface +Group *RouterGroup } class IRoutes{ \u003c\u003einterface +Use() +Handle() +GET() +POST() } class methodTree{ -string method -*node root } class node{ +string path +bool wildChild +uint8 nType +[]node children }\r1. gin.Engine Engine 是 Gin 框架最重要的数据结构，它是框架的入口。我们通过 Engine 对象来定义服务路由信息、组装插件、运行服务。 正如 Engine 的中文意思「引擎」一样，它就是框架的核心发动机，整个 Web 服务的都是由它来驱动的。\n// Engine is the framework's instance, it contains the muxer, middleware and configuration settings. // Create an instance of Engine, by using New() or Default() type Engine struct { RouterGroup ... } 2. gin.RouterGroup RouterGroup 是 Engine 的父类，是对路由树的包装，所有的路由规则最终都是由它来进行管理。\n// RouterGroup is used internally to configure router, a RouterGroup is associated with // a prefix and an array of handlers (middleware). type RouterGroup struct { Handlers HandlersChain basePath string engine *Engine root bool } RouterGroup 实现了 IRoutes 接口，暴露了一系列路由方法，这些方法最终都是通过调用 Engine.addRoute 方法将请求处理器挂接到路由树中。\n// IRoutes defines all router handle interface. type IRoutes interface { Use(...HandlerFunc) IRoutes Handle(string, string, ...HandlerFunc) IRoutes Any(string, ...HandlerFunc) IRoutes GET(string, ...HandlerFunc) IRoutes POST(string, ...HandlerFunc) IRoutes DELETE(string, ...HandlerFunc) IRoutes PATCH(string, ...HandlerFunc) IRoutes PUT(string, ...HandlerFunc) IRoutes OPTIONS(string, ...HandlerFunc) IRoutes HEAD(string, ...HandlerFunc) IRoutes StaticFile(string, string) IRoutes StaticFileFS(string, string, http.FileSystem) IRoutes Static(string, string) IRoutes StaticFS(string, http.FileSystem) IRoutes } 3. gin.node 路由树 在 Gin 框架中，路由规则被分成了最多 9 棵前缀树，每一个 HTTP Method 对应一棵「前缀树」，树的节点按照 URL 中的 / 符号进行层级划分， URL 支持 :name 形式的名称匹配， 还支持 *subpath 形式的路径通配符 。\nGin的路由只需遍历一遍字符串即可，时间复杂度为O(n)。\nfunc New() *Engine { ... engine := \u0026Engine{ ... trees: make(methodTrees, 0, 9), ... } } type node struct { path string // 当前节点相对路径（与祖先节点的 path 拼接可得到完整路径） indices string // 所以孩子节点的path[0]组成的字符串 wildChild bool // 孩子节点是否有通配符（wildcard） nType nodeType // 节点类型 priority uint32 // 当前节点及子孙节点的实际路由数量 children []*node // 孩子节点 handlers HandlersChain // 当前节点的处理函数（包括中间件） fullPath string // 当前节点完整路径 } 4. 示例 r.GET(\"/\", func (context *gin.Context) {}) r.GET(\"/index\", func (context *gin.Context) {}) r.GET(\"/inter\", func (context *gin.Context) {}) r.GET(\"/go\", func (context *gin.Context) {}) r.GET(\"/game/:id/doc\", func (context *gin.Context) {}) flowchart TB / --\u003e in / --\u003e g in --\u003e dex in --\u003e ter g --\u003e o g --\u003e ame ame --\u003e :id :id --\u003e doc\r3、路由过程 func (engine *Engine) handleHTTPRequest(c *Context) { ... // Find root of the tree for the given HTTP method t := engine.trees for i, tl := 0, len(t); i \u003c tl; i++ { // 过滤method if t[i].method != httpMethod { continue } root := t[i].root // Find route in tree // 匹配最佳路由 value := root.getValue(rPath, c.params, c.skippedNodes, unescape) if value.params != nil { c.Params = *value.params } if value.handlers != nil { c.handlers = value.handlers c.fullPath = value.fullPath c.Next() c.writermem.WriteHeaderNow() return } if httpMethod != http.MethodConnect \u0026\u0026 rPath != \"/\" { if value.tsr \u0026\u0026 engine.RedirectTrailingSlash { redirectTrailingSlash(c) return } if engine.RedirectFixedPath \u0026\u0026 redirectFixedPath(c, root, engine.RedirectFixedPath) { return } } break } ... } func (n *node) getValue(path string, params *Params, skippedNodes *[]skippedNode, unescape bool) (value nodeValue) { var globalParamsCount int16 walk: // Outer loop for walking the tree for { prefix := n.path // if len(path) \u003e len(prefix) { if path[:len(prefix)] == prefix { path = path[len(prefix):] // Try all the non-wildcard children first by matching the indices idxc := path[0] for i, c := range []byte(n.indices) { if c == idxc { // strings.HasPrefix(n.children[len(n.children)-1].path, \":\") == n.wildChild if n.wildChild { index := len(*skippedNodes) *skippedNodes = (*skippedNodes)[:index+1] (*skippedNodes)[index] = skippedNode{ path: prefix + path, node: \u0026node{ path: n.path, wildChild: n.wildChild, nType: n.nType, priority: n.priority, children: n.children, handlers: n.handlers, fullPath: n.fullPath, }, paramsCount: globalParamsCount, } } n = n.children[i] continue walk } } if !n.wildChild { // If the path at the end of the loop is not equal to '/' and the current node has no child nodes // the current node needs to roll back to last valid skippedNode if path != \"/\" { for l := len(*skippedNodes); l \u003e 0; { skippedNode := (*skippedNodes)[l-1] *skippedNodes = (*skippedNodes)[:l-1] if strings.HasSuffix(skippedNode.path, path) { path = skippedNode.path n = skippedNode.node if value.params != nil { *value.params = (*value.params)[:skippedNode.paramsCount] } globalParamsCount = skippedNode.paramsCount continue walk } } } // Nothing found. // We can recommend to redirect to the same URL without a // trailing slash if a leaf exists for that path. value.tsr = path == \"/\" \u0026\u0026 n.handlers != nil return } // Handle wildcard child, which is always at the end of the array n = n.children[len(n.children)-1] globalParamsCount++ switch n.nType { case param: // fix truncate the parameter // tree_test.go line: 204 // Find param end (either '/' or path end) end := 0 for end \u003c len(path) \u0026\u0026 path[end] != '/' { end++ } // Save param value if params != nil \u0026\u0026 cap(*params) \u003e 0 { if value.params == nil { value.params = params } // Expand slice within preallocated capacity i := len(*value.params) *value.params = (*value.params)[:i+1] val := path[:end] if unescape { if v, err := url.QueryUnescape(val); err == nil { val = v } } (*value.params)[i] = Param{ Key: n.path[1:], Value: val, } } // we need to go deeper! if end \u003c len(path) { if len(n.children) \u003e 0 { path = path[end:] n = n.children[0] continue walk } // ... but we can't value.tsr = len(path) == end+1 return } if value.handlers = n.handlers; value.handlers != nil { value.fullPath = n.fullPath return } if len(n.children) == 1 { // No handle found. Check if a handle for this path + a // trailing slash exists for TSR recommendation n = n.children[0] value.tsr = (n.path == \"/\" \u0026\u0026 n.handlers != nil) || (n.path == \"\" \u0026\u0026 n.indices == \"/\") } return case catchAll: // Save param value if params != nil { if value.params == nil { value.params = params } // Expand slice within preallocated capacity i := len(*value.params) *value.params = (*value.params)[:i+1] val := path if unescape { if v, err := url.QueryUnescape(path); err == nil { val = v } } (*value.params)[i] = Param{ Key: n.path[2:], Value: val, } } value.handlers = n.handlers value.fullPath = n.fullPath return default: panic(\"invalid node type\") } } } if path == prefix { // If the current path does not equal '/' and the node does not have a registered handle and the most recently matched node has a child node // the current node needs to roll back to last valid skippedNode if n.handlers == nil \u0026\u0026 path != \"/\" { for l := len(*skippedNodes); l \u003e 0; { skippedNode := (*skippedNodes)[l-1] *skippedNodes = (*skippedNodes)[:l-1] if strings.HasSuffix(skippedNode.path, path) { path = skippedNode.path n = skippedNode.node if value.params != nil { *value.params = (*value.params)[:skippedNode.paramsCount] } globalParamsCount = skippedNode.paramsCount continue walk } } //\tn = latestNode.children[len(latestNode.children)-1] } // We should have reached the node containing the handle. // Check if this node has a handle registered. if value.handlers = n.handlers; value.handlers != nil { value.fullPath = n.fullPath return } // If there is no handle for this route, but this route has a // wildcard child, there must be a handle for this path with an // additional trailing slash if path == \"/\" \u0026\u0026 n.wildChild \u0026\u0026 n.nType != root { value.tsr = true return } // No handle found. Check if a handle for this path + a // trailing slash exists for trailing slash recommendation for i, c := range []byte(n.indices) { if c == '/' { n = n.children[i] value.tsr = (len(n.path) == 1 \u0026\u0026 n.handlers != nil) || (n.nType == catchAll \u0026\u0026 n.children[0].handlers != nil) return } } return } // Nothing found. We can recommend to redirect to the same URL with an // extra trailing slash if a leaf exists for that path value.tsr = path == \"/\" || (len(prefix) == len(path)+1 \u0026\u0026 prefix[len(path)] == '/' \u0026\u0026 path == prefix[:len(prefix)-1] \u0026\u0026 n.handlers != nil) // roll back to last valid skippedNode if !value.tsr \u0026\u0026 path != \"/\" { for l := len(*skippedNodes); l \u003e 0; { skippedNode := (*skippedNodes)[l-1] *skippedNodes = (*skippedNodes)[:l-1] if strings.HasSuffix(skippedNode.path, path) { path = skippedNode.path n = skippedNode.node if value.params != nil { *value.params = (*value.params)[:skippedNode.paramsCount] } globalParamsCount = skippedNode.paramsCount continue walk } } } return } } ",
  "wordCount" : "2513",
  "inLanguage": "zh",
  "datePublished": "2022-11-03T15:50:33+08:00",
  "dateModified": "2022-11-03T15:50:33+08:00",
  "author":[{
    "@type": "Person",
    "name": "路非非"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/tech/gin/2-start-analyze/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ruff's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313" accesskey="h" title="Ruff&#39;s Blog (Alt + H)">
                <img src="http://localhost:1313/icon.png" alt="" aria-label="logo"
                    height="35">Ruff&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                    <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/" title="🏠 主页">
                    <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts" title="📜 笔记">
                    <span>📜 笔记</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags" title="🧩 标签">
                    <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/series" title="🧩 系列">
                    <span>🧩 系列</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="⏰ 时间轴">
                    <span>⏰ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about" title="🙋🏻‍♂ 关于">
                    <span>🙋🏻‍♂ 关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs"><a href="http://localhost:1313">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">📜笔记</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/tech/">👨🏻‍💻 技术</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/tech/gin/">gin框架</a></div>
        <h1 class="post-title">
            gin框架(二)、服务启动源码解析
        </h1>
        <div class="post-meta">创建:&nbsp;<span title='2022-11-03 15:50:33 +0800 CST'>2022-11-03</span>&nbsp;|&nbsp;更新:&nbsp;2022-11-03&nbsp;|&nbsp;字数:&nbsp;2513字&nbsp;|&nbsp;时长:&nbsp;6分钟&nbsp;|&nbsp;
作者:&nbsp;路非非



            &nbsp;|&nbsp;标签: &nbsp;
            <ul class="post-tags-meta">
                <a href="http://localhost:1313/tags/go/">go</a>
                <a href="http://localhost:1313/tags/gin/">、gin</a>
            </ul>

            
            
            
            
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_page_pv">
                &nbsp;| 访问: <span id="busuanzi_value_page_pv"></span>
            </span>&nbsp;|&nbsp;<a href="mailto://ruff_ss@foxmail.com?subject=Suggesting%20changes%20for/posts/tech/gin/2-start-analyze.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
    </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1%e6%9c%8d%e5%8a%a1%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b" aria-label="1、服务启动过程">1、服务启动过程</a><ul>
                        
                <li>
                    <a href="#1-gindefault" aria-label="1. gin.Default()">1. gin.Default()</a></li>
                <li>
                    <a href="#2-engineget" aria-label="2. engine.GET()">2. engine.GET()</a></li>
                <li>
                    <a href="#3-enginerun" aria-label="3. engine.Run()">3. engine.Run()</a></li>
                <li>
                    <a href="#4%e6%80%bb%e7%bb%93" aria-label="4.总结">4.总结</a></li></ul>
                </li>
                <li>
                    <a href="#2%e7%bb%93%e6%9e%84%e4%bd%93" aria-label="2、结构体">2、结构体</a><ul>
                        
                <li>
                    <a href="#1-ginengine" aria-label="1. gin.Engine">1. gin.Engine</a></li>
                <li>
                    <a href="#2-ginroutergroup" aria-label="2. gin.RouterGroup">2. gin.RouterGroup</a></li>
                <li>
                    <a href="#3-ginnode-%e8%b7%af%e7%94%b1%e6%a0%91" aria-label="3. gin.node 路由树">3. gin.node 路由树</a></li>
                <li>
                    <a href="#4-%e7%a4%ba%e4%be%8b" aria-label="4. 示例">4. 示例</a></li></ul>
                </li>
                <li>
                    <a href="#3%e8%b7%af%e7%94%b1%e8%bf%87%e7%a8%8b" aria-label="3、路由过程">3、路由过程</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
    <div class="post-content"><h2 id="1服务启动过程">1、服务启动过程<a hidden class="anchor" aria-hidden="true" href="#1服务启动过程">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;pong&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="1-gindefault">1. gin.Default()<a hidden class="anchor" aria-hidden="true" href="#1-gindefault">#</a></h3>
<p><code>gin.Default()</code> 函数会生成一个默认的 <code>Engine</code> 对象，里面包含了 2 个默认的常用插件，分别是 <code>Logger</code> 和 <code>Recovery</code>，<code>Logger</code> 用于输出请求日志，
<code>Recovery</code> 确保单个请求发生 <code>panic</code> 时记录异常堆栈日志，输出统一的错误响应。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Default returns an Engine instance with the Logger and Recovery middleware already attached.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Default</span><span class="p">()</span> <span class="o">*</span><span class="nx">Engine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 输出debug日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">debugPrintWARNINGDefault</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建一个默认无路由无中间件的引擎
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">engine</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 默认注册全局日志和异常捕获中间件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">engine</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nf">Logger</span><span class="p">(),</span> <span class="nf">Recovery</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">engine</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><mark>Gin框架中注册中间件是通过 engine.Use(xx)的方式。</mark></p>
<p>ginMode分为三种场景下的模式，默认为debug模式，可以通过环境变量或代码声明的方式修改模式</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">debugCode = iota
</span></span><span class="line"><span class="cl">releaseCode
</span></span><span class="line"><span class="cl">testCode
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[GIN-debug] [WARNING] Running in &#34;debug&#34; mode. Switch to &#34;release&#34; mode in production.
</span></span><span class="line"><span class="cl"> - using env:   export GIN_MODE=release
</span></span><span class="line"><span class="cl"> - using code:  gin.SetMode(gin.ReleaseMode)
</span></span></code></pre></div><h3 id="2-engineget">2. engine.GET()<a hidden class="anchor" aria-hidden="true" href="#2-engineget">#</a></h3>
<p><code>router.Handle(httpMethod, relativePath, handlers)</code> 用来创建路由，同时框架提供了 <code>GET</code>, <code>POST</code> 等简单方法，<code>relativePath</code> 和 <code>handlers</code>
分别与 <code>router</code> 中 <code>basePath</code> 、<code>handlers</code> 共同组成最终的 <code>absolutePath</code> 和 <code>handlers</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Unless otherwise noted, these are defined in RFC 7231 section 4.3.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodGet</span>     <span class="p">=</span> <span class="s">&#34;GET&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodHead</span>    <span class="p">=</span> <span class="s">&#34;HEAD&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodPost</span>    <span class="p">=</span> <span class="s">&#34;POST&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodPut</span>     <span class="p">=</span> <span class="s">&#34;PUT&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodPatch</span>   <span class="p">=</span> <span class="s">&#34;PATCH&#34;</span> <span class="c1">// RFC 5789
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">MethodDelete</span>  <span class="p">=</span> <span class="s">&#34;DELETE&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodConnect</span> <span class="p">=</span> <span class="s">&#34;CONNECT&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodOptions</span> <span class="p">=</span> <span class="s">&#34;OPTIONS&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">MethodTrace</span>   <span class="p">=</span> <span class="s">&#34;TRACE&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// GET is a shortcut for router.Handle(&#34;GET&#34;, path, handle).
</span></span></span><span class="line"><span class="cl"><span class="c1">// 注册一个匹配路径为 relativePath 的GET请求路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">GET</span><span class="p">(</span><span class="nx">relativePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nf">handle</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">MethodGet</span><span class="p">,</span> <span class="nx">relativePath</span><span class="p">,</span> <span class="nx">handlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// -----
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">httpMethod</span><span class="p">,</span> <span class="nx">relativePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="nx">HandlersChain</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//以&#39;/&#39;连接group.basePath 与 relativePath
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">absolutePath</span> <span class="o">:=</span> <span class="nx">group</span><span class="p">.</span><span class="nf">calculateAbsolutePath</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 合并 group.Handlers 与 handlers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">handlers</span> <span class="p">=</span> <span class="nx">group</span><span class="p">.</span><span class="nf">combineHandlers</span><span class="p">(</span><span class="nx">handlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 将请求路由添加到engine中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">group</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nf">addRoute</span><span class="p">(</span><span class="nx">httpMethod</span><span class="p">,</span> <span class="nx">absolutePath</span><span class="p">,</span> <span class="nx">h</span>   <span class="nx">andlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nf">returnObj</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="3-enginerun">3. engine.Run()<a hidden class="anchor" aria-hidden="true" href="#3-enginerun">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run attaches the router to a http.Server and starts listening and serving HTTP requests.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It is a shortcut for http.ListenAndServe(addr, router)
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note: this method will block the calling goroutine indefinitely unless an error happens.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">addr</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 打印error日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">debugPrintError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 我们可以通过 router.SetTrustedProxies([]string{&#34;192.168.1.2&#34;}) 设置受信任的代理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nf">isUnsafeTrustedProxies</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">debugPrint</span><span class="p">(</span><span class="s">&#34;[WARNING] You trusted all proxies, this is NOT safe. We recommend you to set a value.\n&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies for details.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 解析端口地址，默认使用环境变量PORT，或:8080
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">address</span> <span class="o">:=</span> <span class="nf">resolveAddress</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">debugPrint</span><span class="p">(</span><span class="s">&#34;Listening and serving HTTP on %s\n&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 监听端口地址，engine.Handler作为请求处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">engine</span><span class="p">.</span><span class="nf">Handler</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="4总结">4.总结<a hidden class="anchor" aria-hidden="true" href="#4总结">#</a></h3>
<p><code>Engine</code> 是 <code>Gin</code> 框架的核心数据结构，通过 <code>Engine</code> 对象定义服务路由信息后，使用 <code>http server</code> 启动服务并监听端口地址。</p>
<p><code>Engine</code> 的本质只是对内置的 <code>HTTP</code> 服务器的包装，让它使用起来更加便捷。<code>HTTP</code> 服务器使用的是 <code>Go</code> 语言内置的 <code>http server</code>，</p>
<h2 id="2结构体">2、结构体<a hidden class="anchor" aria-hidden="true" href="#2结构体">#</a></h2>
<div class="mermaid">classDiagram
    Engine --|> RouterGroup
    RouterGroup --o Engine
    RouterGroup --|> IRouter
    IRouter --|> IRoutes
    Engine --o methodTree
    methodTree --o node
    class Engine{
        +[]methodTree methodTrees
        +addRoute()
        +Run()
        +ServeHTTP()
    }
    class RouterGroup{
        +Handlers HandlersChain
	    -engine   *Engine
        +Use()
        +Group()
    }
    class IRouter{
	  <>interface
	  +Group *RouterGroup
    }
    class IRoutes{
	  <>interface
	  +Use()
	  +Handle()
	  +GET()
	  +POST()
    }
    class methodTree{
        -string method
        -*node root
    }
    class node{
        +string path
        +bool wildChild
        +uint8 nType
        +[]node children
    }
</div>
<h3 id="1-ginengine">1. gin.Engine<a hidden class="anchor" aria-hidden="true" href="#1-ginengine">#</a></h3>
<p><code>Engine</code> 是 <code>Gin</code> 框架最重要的数据结构，它是框架的入口。我们通过 <code>Engine</code> 对象来定义服务路由信息、组装插件、运行服务。
正如 <code>Engine</code> 的中文意思「引擎」一样，它就是框架的核心发动机，整个 Web 服务的都是由它来驱动的。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Engine is the framework&#39;s instance, it contains the muxer, middleware and configuration settings.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Create an instance of Engine, by using New() or Default()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Engine</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RouterGroup</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="2-ginroutergroup">2. gin.RouterGroup<a hidden class="anchor" aria-hidden="true" href="#2-ginroutergroup">#</a></h3>
<p><code>RouterGroup</code> 是 <code>Engine</code> 的父类，是对路由树的包装，所有的路由规则最终都是由它来进行管理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// RouterGroup is used internally to configure router, a RouterGroup is associated with
</span></span></span><span class="line"><span class="cl"><span class="c1">// a prefix and an array of handlers (middleware).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">RouterGroup</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Handlers</span> <span class="nx">HandlersChain</span>
</span></span><span class="line"><span class="cl">    <span class="nx">basePath</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">engine</span>   <span class="o">*</span><span class="nx">Engine</span>
</span></span><span class="line"><span class="cl">    <span class="nx">root</span>     <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>RouterGroup 实现了 IRoutes 接口，暴露了一系列路由方法，这些方法最终都是通过调用 Engine.addRoute 方法将请求处理器挂接到路由树中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// IRoutes defines all router handle interface.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">IRoutes</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Use</span><span class="p">(</span><span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Handle</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Any</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GET</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">POST</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DELETE</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">PATCH</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">PUT</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">OPTIONS</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">HEAD</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">StaticFile</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">StaticFileFS</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileSystem</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Static</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl">	<span class="nf">StaticFS</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileSystem</span><span class="p">)</span> <span class="nx">IRoutes</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="3-ginnode-路由树">3. gin.node 路由树<a hidden class="anchor" aria-hidden="true" href="#3-ginnode-路由树">#</a></h3>
<p>在 <code>Gin</code> 框架中，路由规则被分成了最多 9 棵前缀树，每一个 <code>HTTP Method</code> 对应一棵「前缀树」，树的节点按照 <code>URL</code> 中的 / 符号进行层级划分，
<code>URL</code> 支持 <code>:name</code> 形式的名称匹配， 还支持 <code>*subpath</code> 形式的路径通配符 。</p>
<p>Gin的路由只需遍历一遍字符串即可，时间复杂度为O(n)。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">()</span> <span class="o">*</span><span class="nx">Engine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">engine</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Engine</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="nx">trees</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="nx">methodTrees</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">node</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span>      <span class="kt">string</span>             <span class="c1">// 当前节点相对路径（与祖先节点的 path 拼接可得到完整路径）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">indices</span>   <span class="kt">string</span>             <span class="c1">// 所以孩子节点的path[0]组成的字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wildChild</span> <span class="kt">bool</span>               <span class="c1">// 孩子节点是否有通配符（wildcard）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nType</span>     <span class="nx">nodeType</span>           <span class="c1">// 节点类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">priority</span>  <span class="kt">uint32</span>             <span class="c1">// 当前节点及子孙节点的实际路由数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">children</span>  <span class="p">[]</span><span class="o">*</span><span class="nx">node</span>            <span class="c1">// 孩子节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">handlers</span>  <span class="nx">HandlersChain</span>      <span class="c1">// 当前节点的处理函数（包括中间件）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fullPath</span>  <span class="kt">string</span>             <span class="c1">// 当前节点完整路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h3 id="4-示例">4. 示例<a hidden class="anchor" aria-hidden="true" href="#4-示例">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/index&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/inter&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/go&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/game/:id/doc&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{})</span>
</span></span></code></pre></div><div class="mermaid">flowchart TB
/ --> in
/ --> g
in --> dex
in --> ter
g --> o
g --> ame
ame --> :id
:id --> doc
</div>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ startOnLoad: true });
</script>
<h2 id="3路由过程">3、路由过程<a hidden class="anchor" aria-hidden="true" href="#3路由过程">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">handleHTTPRequest</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Find root of the tree for the given HTTP method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">trees</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">tl</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">tl</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 过滤method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">t</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">method</span> <span class="o">!=</span> <span class="nx">httpMethod</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">root</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">root</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Find route in tree
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// 匹配最佳路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">value</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nf">getValue</span><span class="p">(</span><span class="nx">rPath</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">skippedNodes</span><span class="p">,</span> <span class="nx">unescape</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">Params</span> <span class="p">=</span> <span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">fullPath</span> <span class="p">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">fullPath</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">httpMethod</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">MethodConnect</span> <span class="o">&amp;&amp;</span> <span class="nx">rPath</span> <span class="o">!=</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="o">&amp;&amp;</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectTrailingSlash</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">redirectTrailingSlash</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectFixedPath</span> <span class="o">&amp;&amp;</span> <span class="nf">redirectFixedPath</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectFixedPath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="nf">getValue</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">params</span> <span class="o">*</span><span class="nx">Params</span><span class="p">,</span> <span class="nx">skippedNodes</span> <span class="o">*</span><span class="p">[]</span><span class="nx">skippedNode</span><span class="p">,</span> <span class="nx">unescape</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">value</span> <span class="nx">nodeValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">globalParamsCount</span> <span class="kt">int16</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">walk</span><span class="p">:</span> <span class="c1">// Outer loop for walking the tree
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">prefix</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">path</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">path</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)]</span> <span class="o">==</span> <span class="nx">prefix</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">path</span> <span class="p">=</span> <span class="nx">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">prefix</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="c1">// Try all the non-wildcard children first by matching the indices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">idxc</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">indices</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="nx">idxc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="c1">//  strings.HasPrefix(n.children[len(n.children)-1].path, &#34;:&#34;) == n.wildChild
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">wildChild</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">index</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">							<span class="o">*</span><span class="nx">skippedNodes</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[:</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">							<span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">								<span class="nx">path</span><span class="p">:</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="nx">path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">								<span class="nx">node</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">node</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">									<span class="nx">path</span><span class="p">:</span>      <span class="nx">n</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">									<span class="nx">wildChild</span><span class="p">:</span> <span class="nx">n</span><span class="p">.</span><span class="nx">wildChild</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">									<span class="nx">nType</span><span class="p">:</span>     <span class="nx">n</span><span class="p">.</span><span class="nx">nType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">									<span class="nx">priority</span><span class="p">:</span>  <span class="nx">n</span><span class="p">.</span><span class="nx">priority</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">									<span class="nx">children</span><span class="p">:</span>  <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">									<span class="nx">handlers</span><span class="p">:</span>  <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">									<span class="nx">fullPath</span><span class="p">:</span>  <span class="nx">n</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">								<span class="p">},</span>
</span></span><span class="line"><span class="cl">								<span class="nx">paramsCount</span><span class="p">:</span> <span class="nx">globalParamsCount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">						<span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="k">continue</span> <span class="nx">walk</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">!</span><span class="nx">n</span><span class="p">.</span><span class="nx">wildChild</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// If the path at the end of the loop is not equal to &#39;/&#39; and the current node has no child nodes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// the current node needs to roll back to last valid skippedNode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="nx">path</span> <span class="o">!=</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">for</span> <span class="nx">l</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">);</span> <span class="nx">l</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">skippedNode</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[</span><span class="nx">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">							<span class="o">*</span><span class="nx">skippedNodes</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[:</span><span class="nx">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">							<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">skippedNode</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">								<span class="nx">path</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">path</span>
</span></span><span class="line"><span class="cl">								<span class="nx">n</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">								<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">									<span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)[:</span><span class="nx">skippedNode</span><span class="p">.</span><span class="nx">paramsCount</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">								<span class="p">}</span>
</span></span><span class="line"><span class="cl">								<span class="nx">globalParamsCount</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">paramsCount</span>
</span></span><span class="line"><span class="cl">								<span class="k">continue</span> <span class="nx">walk</span>
</span></span><span class="line"><span class="cl">							<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="c1">// Nothing found.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// We can recommend to redirect to the same URL without a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// trailing slash if a leaf exists for that path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="p">=</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="c1">// Handle wildcard child, which is always at the end of the array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">				<span class="nx">globalParamsCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">switch</span> <span class="nx">n</span><span class="p">.</span><span class="nx">nType</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">case</span> <span class="nx">param</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// fix truncate the parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="c1">// tree_test.go  line: 204
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">					<span class="c1">// Find param end (either &#39;/&#39; or path end)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="nx">end</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">					<span class="k">for</span> <span class="nx">end</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span><span class="p">[</span><span class="nx">end</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">end</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="c1">// Save param value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="nx">params</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">cap</span><span class="p">(</span><span class="o">*</span><span class="nx">params</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="p">=</span> <span class="nx">params</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="c1">// Expand slice within preallocated capacity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)[:</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="nx">val</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">[:</span><span class="nx">end</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="nx">unescape</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">QueryUnescape</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">								<span class="nx">val</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">							<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">Param</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">Key</span><span class="p">:</span>   <span class="nx">n</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
</span></span><span class="line"><span class="cl">							<span class="nx">Value</span><span class="p">:</span> <span class="nx">val</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="c1">// we need to go deeper!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="nx">end</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">path</span> <span class="p">=</span> <span class="nx">path</span><span class="p">[</span><span class="nx">end</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">							<span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">							<span class="k">continue</span> <span class="nx">walk</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">						<span class="c1">// ... but we can&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">==</span> <span class="nx">end</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span><span class="p">;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">value</span><span class="p">.</span><span class="nx">fullPath</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">fullPath</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="c1">// No handle found. Check if a handle for this path + a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="c1">// trailing slash exists for TSR recommendation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="p">=</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">indices</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">case</span> <span class="nx">catchAll</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// Save param value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="nx">params</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="p">=</span> <span class="nx">params</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="c1">// Expand slice within preallocated capacity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>						<span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						<span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)[:</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="nx">val</span> <span class="o">:=</span> <span class="nx">path</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="nx">unescape</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">QueryUnescape</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">								<span class="nx">val</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">							<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">Param</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="nx">Key</span><span class="p">:</span>   <span class="nx">n</span><span class="p">.</span><span class="nx">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span>
</span></span><span class="line"><span class="cl">							<span class="nx">Value</span><span class="p">:</span> <span class="nx">val</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span>
</span></span><span class="line"><span class="cl">					<span class="nx">value</span><span class="p">.</span><span class="nx">fullPath</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">fullPath</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">					<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;invalid node type&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">path</span> <span class="o">==</span> <span class="nx">prefix</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// If the current path does not equal &#39;/&#39; and the node does not have a registered handle and the most recently matched node has a child node
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// the current node needs to roll back to last valid skippedNode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span> <span class="o">!=</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="nx">l</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">);</span> <span class="nx">l</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">skippedNode</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[</span><span class="nx">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">					<span class="o">*</span><span class="nx">skippedNodes</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[:</span><span class="nx">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">skippedNode</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">path</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">path</span>
</span></span><span class="line"><span class="cl">						<span class="nx">n</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)[:</span><span class="nx">skippedNode</span><span class="p">.</span><span class="nx">paramsCount</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="nx">globalParamsCount</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">paramsCount</span>
</span></span><span class="line"><span class="cl">						<span class="k">continue</span> <span class="nx">walk</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//	n = latestNode.children[len(latestNode.children)-1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// We should have reached the node containing the handle.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// Check if this node has a handle registered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span><span class="p">;</span> <span class="nx">value</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">value</span><span class="p">.</span><span class="nx">fullPath</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">fullPath</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// If there is no handle for this route, but this route has a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// wildcard child, there must be a handle for this path with an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// additional trailing slash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">wildChild</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">nType</span> <span class="o">!=</span> <span class="nx">root</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// No handle found. Check if a handle for this path + a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// trailing slash exists for trailing slash recommendation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">indices</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">					<span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="p">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">						<span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">nType</span> <span class="o">==</span> <span class="nx">catchAll</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Nothing found. We can recommend to redirect to the same URL with an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// extra trailing slash if a leaf exists for that path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="p">=</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">prefix</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">				<span class="nx">path</span> <span class="o">==</span> <span class="nx">prefix</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// roll back to last valid skippedNode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">value</span><span class="p">.</span><span class="nx">tsr</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span> <span class="o">!=</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">l</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">);</span> <span class="nx">l</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">skippedNode</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[</span><span class="nx">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">				<span class="o">*</span><span class="nx">skippedNodes</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">skippedNodes</span><span class="p">)[:</span><span class="nx">l</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">skippedNode</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">path</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">path</span>
</span></span><span class="line"><span class="cl">					<span class="nx">n</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">value</span><span class="p">.</span><span class="nx">params</span><span class="p">)[:</span><span class="nx">skippedNode</span><span class="p">.</span><span class="nx">paramsCount</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="nx">globalParamsCount</span> <span class="p">=</span> <span class="nx">skippedNode</span><span class="p">.</span><span class="nx">paramsCount</span>
</span></span><span class="line"><span class="cl">					<span class="k">continue</span> <span class="nx">walk</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

    </div>

    <footer class="post-footer">
        <ul class="post-tags">
            <li><a href="http://localhost:1313/tags/go/">go</a></li>
            <li><a href="http://localhost:1313/tags/gin/">gin</a></li>
        </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/tech/gin/1-start/">
    <span class="title">« 上一页</span>
    <br>
    <span>gin框架(一)、快速入门</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/life/one/">
    <span class="title">下一页 »</span>
    <br>
    <span>One</span>
  </a>
</nav>

    </footer>
</article>
    </main>
    
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
